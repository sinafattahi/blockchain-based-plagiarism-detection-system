Diamond-based quantum sensors have enabled high-resolution NMR spectroscopy at the microscale in scenarios where fast molecular motion averages out dipolar interactions among target nuclei. However, in samples with low-diffusion, ubiquitous dipolar couplings challenge the extraction of relevant spectroscopic information. In this work we present a protocol that enables the scanning of nuclear spins in dipolarly-coupled samples at high magnetic fields with a sensor based on nitrogen vacancy (NV) ensembles. Our protocol is based on the synchronized delivery of radio frequency (RF) and microwave (MW) radiation to eliminate couplings among nuclei in the scanned sample and to efficiently extract target energy-shifts from the sample’s magnetization dynamics. In addition, the method is designed to operate at high magnetic fields leading to a larger sample thermal polarization, thus to an increased NMR signal. The precision of our method is ultimately limited by the coherence time of the sample, allowing for accurate identification of relevant energy shifts in solid-state systems.

Over the past decade, quantum sensing–a notably prolific branch of quantum technologies1,2, has produced magnetometers able to detect ever weaker fields. Such development has had a deep impact in the realm of nuclear magnetic resonance (NMR)3, a field that, despite its unquestionable success, has limitations due to the inherent weakness of target signals necessitates the scanning of millimeter-sized samples. Nitrogen vacancy (NV) centers in diamond4, however, reported the detection of signals from smaller samples leading to NMR experiments with unprecedented spatial resolution. NV centers stand out for their capacity to operate at room temperature leading to smaller, and easier to operate magnetometers compared to platforms that require stringent conditions such as, e.g., superconducting quantum interference devices (SQUIDs).

NMR spectroscopy reveals frequency shifts relative to a base Larmor frequency which encode structural information about sample molecules as well as of their surrounding environment. In this scenario, one of the most impressive results produced by NV based NMR sensors –enabled by heterodyne protocols that overcome the resolution boundary posed by the coherence time of the NV centers5,6– is the record of spectral features from picoliter volume samples with high-resolution7. Nevertheless, in thermally polarized samples, these protocols require a high nuclear spin concentration (typically, highly protonated samples) and a significant number of repetitions to obtain meaningful results. A possibility for detecting samples at lower concentrations and achieving more competitive protocols is to hyperpolarize the samples in a previous step8,9. In addition, performing the experiment at high fields directly provides higher polarization rates while it facilitates the extraction of relevant information from the recorded spectra, as chemical shifts increase and J-couplings become clearer10. Although NV-NMR spectroscopy at high fields has not yet been experimentally demonstrated, recent proposals have introduced protocols that enable the acquisition of high-resolution spectra in strong external magnetic fields11–13. In particular, our proposal AERIS12operates encoding the target nuclear energy shifts in the amplitude variation of the sample’s longitudinal magnetization which oscillates at a tunable rate –i.e., at a slow rate of, typically, tens of KHz even at large fields– during consecutive detections.

An important limitation of state-of-the-art NV-NMR spectroscopy is caused by the strong dipolar coupling among target nuclei, which results in intricate spectra that challenge data interpretation. This becomes especially critical in solid-state material research, where homonuclear dipole-dipole interactions hinder subtler couplings (heteronuclear interactions are less challenging as they can be eliminated by driving only one of the species). The NMR community has dedicated significant efforts to mitigate the impact of dipolar interactions15, and today solid-state NMR spectroscopy is extensively used in distinct research areas: In pharmaceutics it characterizes active pharmaceutical ingredients (APIs) and their interaction with excipients (inactive substances added to a drug that serve various purposes such as binding or preserving the API)16–18, among many other applications (see19for an extensive review on the topic). In epidemiology, it provides key insights of the structure of molecules related with diseases as present in our societies as Alzheimer20. In energy storage research is used to characterize the local structure of solid materials used in batteries and fuel cells21.

These areas, along with many others, would largely benefit from sensors able to produce narrower spectral lines from smaller solid-state samples, especially over material surfaces where conventional NMR techniques are highly constrained. While NV-NMR spectroscopy emerges as the prominent technique to access samples in the microscale regime, it is currently limited to liquid state samples where dipole-dipole interactions get naturally averaged out due to fast molecular motion, leaving a plethora of solid-state applications out of its range of action. Extending high-field NV-NMR protocols, such as AERIS, to solid-state samples by effectively decoupling dipolar interactions, would unlock these applications22,23.

In this work, we devise a protocol that overcomes these limitations and enables high resolution NV-NMR spectroscopy of single crystals with strong homonuclear dipolar coupling at elevated external magnetic fields, allowing to take advantage from the higher polarization rates and stronger chemical shifts. Our protocol features the delivery of two radiation channels –radio-frequency (RF) and microwave (MW)– synchronized with measurements on an NV ensemble magnetometer. The RF channel drives the sample with a twofold purpose. On the one hand it effectively decouples the target nuclear spins, diminishing the effect of strong homonuclear couplings in the recorded spectra, and enabling the obtention of nuclear energy shifts. Remarkably, the decoupling benefits from increasing RF intensities could be specially effective in the small volume regime, where the driving field tends to be more homogeneous. In this regime, current RF antenna designs have demonstrated nuclear spin rotation rates in the tens to hundreds of kilohertz range24,25. On the other hand, the RF bridges the interaction among NV sensors and fast rotating nuclear spin by generating a slow-frequency NMR signal trackable by the NV sensor. Simultaneously, the MW channel delivers a tailored pulse sequence to the NV ensemble enabling the detection of the magnetic field emitted by the driven sample. This sequence is interspersed with measurements of the sensor’s state to construct the spectra in a heterodyne frame leading to a spectrum only limited by the nuclear sample coherence. Finally, we provide analytical expressions that map the detected resonances with target energy shifts.

Lee and Goldburg (LG) showed in a seminal paper26that an off-resonant continuous RF field cancels, up to first order, the contribution to the nuclear spin dynamics of homonuclear dipole-dipole interactions if theLG conditionholds. Here,is the detuning between the carrier frequency of the RF driving field () and the Larmor precession of the spins (), andis the Rabi frequency of the RF driving. Subjecting a spin ensemble to an off-resonant RF field leads to collective nuclear spin rotations along an axis tilted with respect to(the direction of the static magnetic field). More specifically,the tilted axis–in the followingP– has a componentalong, while its projection on the orthogonalxyplane is.

Further developments have built upon the original LG sequence demonstrating the ability to remove higher order contributions of the dipole-dipole interaction, thus leading to even narrower spectral lines. Prominent examples are the frequency-switched (FSLG)28and phase-modulated (PMLG)29versions of the original LG sequence. Our protocol incorporates the advanced LG4 sequence30over nuclei, which exhibits remarkable decoupling rates and enhanced robustness against RF control errors. The LG4 consists on concatenated blocks of four consecutive off-resonant RF drivings, all complying with the LG condition, leading to rotations along four different axes. This is, the rotation axisPalternates amongand, whose relative positions are illustrated in Fig.1a. Note that, at each block, nuclear spins undergo two sets of complementary rotations along axis pointing in opposite directions (and). To further illustrate the journey of the magnetization during an LG4 block we include an animation31.

(a) Relative positions of axis(clear-blue),(dark-blue),(clear-magenta),(dark-magenta). The motion of the magnetization in between LG4 blocks () is shown in purple. This evolution is described as a rotation in the plane (in yellow) perpendicular to theaxis in accordance with the effective Hamiltonian in Eq. (4) for a single. (b) (Top) Magnetization rotations during each of the four RF drivings. (Bottom) Projection of the magnetization ontoas it rotates during a full LG4 block. This projection determines the magnetic signal for the NV ensemble sensor.

According to the LG4 scheme30, the phase of the driving is set toto minimize the line-width of the resonances.

Note that in Eq. (1) we assume that the internuclear interaction Hamiltoniancan be neglected due to the introduced decoupling sequence. This assumption simplifies the subsequent analysis. However,will be taken into account in the numerical model in the results section.

In the remainder of this section, we analyze the signal emitted by the sample subjected to the RF decoupling fields and develop analytical expressions for the target energy shifts.

Hereafter, we often refer tos(t) as the signal, as it constitutes the target field for the NV ensemble sensor. In fact, its amplitude, phase, and static biasbdepend on the configuration of the nuclear spin ensemble and thereby on theenergy shifts (see27), so detecting and properly readings(t) enables to unravel the desired information.

Consequently, the LG4 meets a twofold goal. Namely: (i) It results in a nuclear spin dynamics with minimal effect from the dipole-dipole interaction (see27for the full derivation of the Hamiltonian in Eq. (1)), enabling the identification of the weaker but interestingshifts. (ii) It induces a tunable rotation speed in the sample (, see Eq. (3)), facilitating the interaction between nuclear spins and the NV ensemble sensor even at high external magnetic fields. Regarding point (ii), it is important to note that without using RF drivings on the sample, standard techniques based on imprinting in the NVs a rotation speed comparable to the nuclear Larmor frequency would necessitate the application of unrealistic MW fields. For context, in a magnetic field of approximately 2.35 Tesla, hydrogen spins rotate at a speed ofMHz, producing a signal hardly trackable by an NV ensemble sensor operating with conventional methods7–9.

Now, we examine the effects of RF decoupling fields in greater detail. Each RF driving (leading to the rotations along,) is applied for an interval. Consequently, the total signal emitted by the sample is a composite of distinct sinusoidal functions, condensed in Eq. (3), each persisting for a durationT. Figure1b presents an illustrative example ofs(t) by showing the rotation of a single magnetization vector (associated with a specific) around axesand.

In summary, this section demonstrates that each LG4 block alters the sample magnetizationthrough rotations along theaxis, as depicted in Fig.1a. An animation of the magnetization precession around theaxis (leading to the yellow rotation plane Fig.1a) is available in32. Moreover, we elucidate the mechanism governing the evolution ofthrough the effective Hamiltonian outlined in Eq., while Eq. (5) establishes analytical expressions connecting the rates of the effective rotations,, with the target nuclear shifts.

In the next section we outline the protocol to monitor this effective precessions with the NV ensemble sensor and extract the desiredenergies from its recordings.

The target magnetic field over the NV ensemble sensor is a concatenation of the sinusoidal signals in Eq. (3) (see lower panel in Fig.1b). A particular RF field at theLG4 block (note that, the accumulative character of the rotations imposed by Eq. (4) make it crucial to identify the number of the block from now on), produces a nuclear spin rotation around a certain axis (or) where the amplitudeof the resulting signalis directly proportional to(i.e., to the magnetization component which is orthogonal to the rotation axis –or– at the start of each RF driving), and the phasecorresponds to the angle betweenand. The latter is the component ofthat lies on the plane perpendicular to the rotation axis. See the lower panel in Fig.2a and27for more details.

(a) Illustration of a CPMG pulse block (upper panel) and its geometric interpretation (lower panel). This panel shows a projection of the sphere in Fig.1(b) viewed in a direction parallel to axis, as represented with the eye symbol. This view facilitates the representation of the projections onto the plane perpendicular to A of (i) The magnetization vector, denoted as, and (ii) Theaxis, referred to as. In addition, it shows the trajectory followed by a magnetization vector during a rotation aroundA(purple circle) and after successive LG4 blocks (yellow ellipse). (b) Upper panel, pulse block of our tailored sequence where the initialpulse is delivered at a time. With this control, the phase accumulation of the NV is proportional to the projection ofonto(shown in red), an axis tilted away fromand aligned with the major axis of the yellow ellipse for optimal contrast. (c) Evolution of the projection ofonto axis(red) and onto axis(blue). The amplitude of the projection onto, resulting from the sequence in panel (b), reaches the maximum value of 1. As the phase accumulated by the NV is directly proportional to this projection, the timing of the pulses in (b) ensures the maximum phase accumulation amplitude.

We now use this geometric description to analyze the phase accumulated by each NV in the ensemble sensor when subjected to a generic pulse sequence. For this analysis, we choose a standard Carr-Purcell-Meiboom-Gill (CPMG) sequence33,34. In order to keep the discussion accessible, we focus on the signal produced by the nuclear spins rotating aroundand limit ourselves to an scenario involving a single effective energy shift,. Note, however, that the following results and the consequent conclusions are valid for signals produced by nuclear spins rotating around axesandand in situations involving multiple shifts.

Hence, the phase accumulated by each NV is proportional to the projection ofonto, or, in other words, to the quantity. The lower panel of Fig.2a provides a clarifying (probably most needed) graphic explanation.

whereis the spin density of theith nucleus,is detemined by the pulse sequence anddepends on both the pulse sequence and the initial nuclear state. A formal derivation of (7) as well as further details can be found in27. The 0 subindex in Eq. (7) indicate that all parameters correspond to the reference CPMG sequence (note that, in the next section we derive an improved sequence). Thus, the NV response enclosed in Eq. (7) consists on a sum of sinusoidal functions that encode the differentwhich can be then extracted via standard Fourier transform. Finally,targets can be obtained via a direct application of Eq. (5).

In our geometrical framework, adjusting the timing of the pulses results in an accumulated phase proportional to the projection ofonto an axis, which is tilted at an anglerelative to(see Fig.2b).

The ability to pivot the axis in whichgets projected (note this can be done by selecting distinct values forsince) allows us to design a pulse sequence that maximizes contrast in the recorded spectra. From block to block,evolves following an ellipse, therefore, we design the pulse sequence so that the phase accumulated by each NV is proportional to the projection ofinto the major axis of the elipse. By doing so, the projecting axis and the direction that contains the extreme points of the elliptic path ofmatch, thereby yielding the maximum amplitude in the oscillation ofin successive blocks, see Fig.2b. In particular, this is achieved by setting, which determines the timing of the pulses asfor optimal detection of the signal produced by the nuclear spins rotating aroundA. Repeating the same analysis for the signals produced by nuclear spin rotations aroundandwe findand.

where(i.e., with the tailored MW sequence the contrast increases a) andwhich corresponds to a initial sample magnetization oriented along the axis perpendicular to theandaxes, achieved by a RF pulse that triggers the protocol. Finally, we access the effective frequenciesby Fourier transforming the recorded data and obtain the targetshifts from Eq. (5).

(Top) General layout of our protocol containing the RF control over nuclear spins and the MW pulse sequence on the NV ensemble. The magnetic field emitted by the nuclei as a consequence of the RF rotations is depicted in light purple. As time progresses, this field changes its shape, which changes the phase accumulated by the NV, while MW pulses keep always the same structure. (Bottom) Evolution of the expected results for the measurement over the NVs as the experiments progresses, showing a sinusoidal pattern with frequency. In the presence of additional shifts, the measurement outcomes evolve as a sum of sinusoidal components with corresponding frequencies, which can be extracted through Fourier transform analysis.

We test our protocol by simulating its implementation to detect the chemical shifts of hydrogen nuclear spins in ethanol molecules () at high external magnetic field. Although ethanol typically exists as a liquid, we employ its solid configuration as an example of an ordered sample with strong homonuclear dipole-dipole couplings. In particular, ethanol molecules exhibit dipolar couplings of up to 17 kHz (the proton attached to the oxygen shows limited dipole interaction with the rest of the system so we exclude it from the simulations). High external fields improve nuclear magnetic resonance procedures, not only because it yields higher polarization rates, but also because it enhances the weaker, and thus harder to detect, energy shifts. In our simulations, we consider an external field ofT, with chemical shifts of 3.66 ppm for three of the protons and 1.19 ppm for the other two, corresponding to frequency shifts of approximately 327 Hz and 106 Hz, respectively.

whereis the target nuclear shift of theith hydrogen atom andis the driving noise modeled with an Ornstein-Uhlenbeck process with a 1 ms correlation time and 0.24% amplitude.

whereis the number density of hydrogen spins for ethanol, andis a geometric factor that relates the sample magnetization and the magnetic field in the NV location, see7,12for further details.

withthe control Rabi frequency, anddescribing potential RF-induced crosstalk on the NVs. Following the protocol devised in this work, they interact with the signals produced by the nuclear spin rotations around axisandand accumulate a phase determined by the state of the sample magnetization. During the time that corresponds to the delivery of theRF field over the sample, we transform the accumulated phase into a population difference with apulse and simulate the measurement, after which the sensor is reinitialized and the protocol repeats. Finally, a Fourier transform of the measurements provides the spectra displayed in Fig.4, which proves the ability of our protocol to access the chemical shifts of the molecule.

Spectra obtained from three simulations with RF Rabi frequencies of100 kHz (yellow line),150 kHz (blue line), and200 kHz (red line). Vertical dashed gray lines indicate the expected resonances, i.e. the two, of approximately 140 Hz and 45 Hz. For comparison, a spectrum obtained with AERIS is depicted (black line), using an RF Rabi frequency of150 KHz. In all simulations, the nuclear sample starts in a thermal state corresponding to a temperature of T=300 K in an external magnetic field of 2.1 T. The sample evolves for a total time of 0.5 s.

Figure4shows three different experiments with increasing RF intensities. As expected, stronger RF drivings lead to clearer spectra, less distorted by spurious peaks which arise due to incomplete averaging of dipolar couplings. In particular we simulate RF drivings with Rabi frequencies of100 kHz,150 kHz, and200 kHz, all attainable values by state of the art antennas24,25, and set the Rabi frequency of the MW control at 20 MHz in all cases. Note that when the RF Rabi frequency exceeds the 17 KHz dipolar coupling strength by an order of magnitude, the resulting spectra become significantly cleaner and more resolved. As intended, our method leads to resonance peaks centred infrom which one can extract the target nuclear shiftsusing Eq. (5). For comparison, we include the results of a fourth simulation using AERIS12, which does not incorporate any dipolar coupling suppression technique. In this case, the obtained spectra (black-curve) is distorted as a consequence of the strong nuclear dipolar couplings.

In summary, we have demonstrated that our protocol effectively identifies the target energy shiftswith strong nuclear dipole-dipole interactions at high external magnetic fields.

We have designed a protocol that utilizes LG4 sequences and a tailored NV pulse train to identify chemical shifts in the presence of strong dipole-dipole interactions. The RF field serves two key purposes: (i) decoupling nuclear spins and (ii) generating a nuclear signal oscillating at a moderate frequency that can be measured by the NVs, allowing the protocol to operate at high magnetic fields. By incorporating a tailored MW sequence on the NV for signal detection, we achieve effective retrieval of chemical shifts. Finally, the accuracy of our method is ultimately limited by the nuclear sample decoherence, thus surpassing the limitations imposed by NVs dephasing and thermalization. Our findings pave the way for the advancement of microscale NMR techniques and broaden their application in diverse fields, such as materials science, chemistry, and biology.

C.M.-J. acknowledges the predoctoral MICINN grant PRE2019-088519. J. C. acknowledges the Ramón y Cajal (RYC2018-025197-I) research fellowship. Authors acknowledge the Quench project that has received funding from the European Union’s Horizon Europe – The EU Research and Innovation Programme under grant agreement No 101135742, the Spanish Government via the Nanoscale NMR and complex systems project PID2021-126694NB-C21, and the Basque Government grant IT1470-22. A.T. acknowledges support from the Horizon Europe project QCircle 101059999 (Teaming for Excellence).