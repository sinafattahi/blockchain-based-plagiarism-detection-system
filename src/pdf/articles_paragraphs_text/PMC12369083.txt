Knowledge-Based Planning (KBP) pipelines, which integrate machine learning-based models to predict dose distribution, have gained popularity in clinical radiation therapy. However, for patients with specific requirements, the trained models may struggle to rapidly adjust to guide the automatic planning process. Therefore, the aim of this study was to calibrate the dose prediction model to improve the quality and accuracy of automatic planning for cervical cancer radiation therapy.

We retrospectively collected a routine cervical cancer dataset (200 cases) to conduct the KBP pipelines for automatically generating radiation planning, and a small number of ovarian-protection and myelosuppressive datasets (21 cases) to calibrate and evaluate the dose prediction model. A total of three criteria-calibration approaches to solve the data imbalance problem in dose prediction were introduced and compared, includingPrediction Tolerancefunction on uTPS (United Imaging Healthcare Co., Ltd., Shanghai), transfer learning, and mixture density network.

ThePrediction Tolerancefunction allowed for rapid optimization adjustments without model modification, which is suitable for patients with strong desires for ovary protection. The transfer learning approach required minimal training time and data to generate acceptable automatic planning results. The Mixture Density Network (MDN) approach, although the most time-consuming to train, achieved robust prediction results and facilitated dataset analysis. The MDN method showed the greatest consistency between predicted dose distribution and actual optimization outcomes, highlighting its potential as a reliable calibration method for dose prediction.

This study demonstrated an automatic KBP workflow and compared three criteria-calibration approaches to address the data imbalance problem in dose prediction. These approaches can partially calibrate pre-existing models to accommodate newly added criteria and could be implemented according to specific requirements in different scenarios. Although there are trade-offs in various aspects, they all can generate feasible radiation treatment plans.

The online version contains supplementary material available at 10.1186/s13014-025-02684-x.

Cervical cancer is a major health problem worldwide, ranking fourth in incidence and mortality among women [1,2]. Radiation therapy is a common treatment modality for cervical cancer, where a high dose of radiation is delivered to the planning target volume (PTV) and a low dose to the organs-at-risk (OARs) [3–5]. However, manual radiotherapy planning is time-consuming and challenging, especially the volumetric modulated arc therapy (VMAT) planning technique, given the increasing demands for radiation therapy [6]. Therefore, it is essential to develop a workflow that can automatically generate the optimal radiotherapy plan. The simplest approach is to build a protocol-based workflow based on the goal sheet, and the approach has been proven to be effective in many cases, such as Rapidplan technique [4,7,8]. However, the protocol-based auto-planning may not suitable for all patients due to their unique conditions, such as tumor location and motion, protection of OARs, and prognosis [9]. Therefore, in order to reduce the patient toxicity and adverse effects, it is critical to develop an adaptable auto-planning workflow that takes into account individual patient characteristics.

In recent years, the development of a Knowledge-Based Planning (KBP) workflow has been introduced [10], which utilizes the historical high-quality plans to guide a process that generates patient-specific treatment plans. This workflow typically consists of two stages: (1) predicting dosimetric indices, such as DVH prediction and three-dimensional dose distribution prediction, and (2) optimizing a treatment plan based on the predicted dosimetric indices. The dosimetric index prediction process can be implemented by data-driven models. The progress made in machine learning and deep learning algorithms for computer vision has sparked interest among radiation oncology researchers. The models including linear regression [11,12], principal component analysis [13–15], random forest [16,17], and neural networks [18,19] are employed for DVH prediction. In addition, the deep learning methods, such as convolutional neural network (CNN), have been widely applied to solve medical image-related tasks. Specially, UNet [20], and its variants [21–23] have achieved impressive improvements in medical image segmentation, and have been successfully implemented in other medical image-related fields, such as three-dimensional dose distribution prediction in radiation treatment planning [24–30]. These models, trained by contoured CT images of historical high-quality plans as input, are able to predict the patient-specific dose distribution corresponding to optimal treatment outcomes. Furthermore, several commercial treatment planning system (TPS), e.g., Eclipse (Varian Medical Systems, Palo Alto, CA), has integrated KBP workflow into TPS [31]. The clinical practice indicates that the KBP workflow has enhanced the quality of treatment plans and shortened the time required for planning [32].

While the deep learning-based models show the potential of accurately predicting expected dose distribution, the effectiveness of their application largely depend on the quality and consistency of the training data. One of the causes for data heterogeneity in previous plans is the modification of criteria, which can lead to variations in the planning style. Due to the lack of style adaptability, a dose prediction model trained on criteria-specific dataset may not be capable of directly generating treatment plans based on other criteria. Additionally, the amount of data in new criteria is relatively limited, which often makes it challenging to train a new model. In contrast, if the dataset of mixed criteria is used for model training, the model may be biased towards predicting the “average” style, which can impact the accuracy of the prediction results. Consequently, the effectiveness of criteria calibration for deep learning based dose prediction model is critical to ensure reliable and accurate treatment planning.

In this study, we collected several cervical cancer treatment plans and divided them into two datasets based on a specific time point, with the plans after the time point were stricter in criteria and limited in number. In addition, an automatic knowledge-based planning workflow was developed base on uTPS (United Imaging Healthcare Co., Ltd., Shanghai). The deep learning model was integrated into uTPS via its application programming interface, and the plans were generated using its optimization algorithms developed in-house. To address the issue of criteria adaptation, we compared three approaches for calibrating dose criteria to deal with an extreme imbalance dataset: the function ofPrediction Tolerancefunction on uTPS (United Imaging Healthcare Co., Ltd., Shanghai), transfer learning-based method and Mixture Density Network (MDN). The results of this study provide a foundation for the development of improved KBP methods that can help overcome the cross-domain adaptation challenges associated with cervical cancer treatment planning.

We retrospectively collected VMAT planning patients of cervical cancer (including postoperative radiotherapy and definitive radiotherapy) in Peking Union Medical College Hospital. Dataset A (2018.06-2021.04, 200 patients) followed the original criteria(RTOG 90 − 01 and TG 101), while Dataset B (2021.4.4-2022.10, 21 patients) were added criteria of Dmean and D5% of Femoral Head L/R, and Dmean and D90% of Bone Marrow, of which optimization constraints were more strict to limit the dosage of femoral heads and bone marrow.

The workflow of the cervical cancer radiation treatment automatic planning is presented in Fig.1. The process begins with the selection of the patient, after which the physician checks the contours of Regions of Interest (ROI) and the isocenter, identifies the prescription and sets the planning parameters. Next, the knowledge-based auto-planning engine is launched. The first step of this process is the dose prediction, which provides a patient-specific dose distribution that should be delivered. The predicted dose distribution is then transformed into optimization constraints in conjunction with the clinical goal sheet. Subsequently, the optimization process begins based on the constraints and set planning parameters. After the loops of optimization are completed, an executable treatment plan is generated.

Anatomic attention mechanisms for complex pelvic geometries.

Tight integration with multi-objective optimization. This enables direct clinical deployment for gynecological radiotherapy.

To predict the three-dimensional dose distribution, we utilized the Channel Attention Densely-connected U-Net (CAD-UNet) [28]. This architecture replaced the convolution layers of the traditional U-Net with newly designed blocks that integrated both channel attention and dense connections, referred to as CAD Blocks. The input data of CAD-UNet contains 9 channels of ROI masks labelled by 1, including PCTV (6 mm expanded by CTV), Spinal Cord, Bladder, Rectum, Femoral Head L, Femoral Head R, Bone Marrow, Small Intestine and Body. The output data were the dose distribution, which is assumed to correspond to the pareto treatment planning.

The weighted mean square error (MSE) loss is shown above, whereandrepresents the predicted dose matrix and ground truth dose matrix. V denotes the total voxel number of output data and w denotes the weight map of this function. The weight for a voxel in a ROI is the reciprocal of the ROI volume as a percentage of the total voxel number.

The clinical goal sheet, including target prescription and dosimetric requirements for organs of interest, was derived from the clinical wish-list prescribed by physicians. Priority could be set in the goal sheet to represent the trade-offs between organs and targets as well as the arrangement of organs’ importance, where a lower Priority value indicates a higher priority. The specific goal sheet used in this study is presented in Table1. ThePrediction Tolerancefunction will be introduced in Sect.2.3.1.

The functionPrediction Tolerancewas developed for convenient and rapid optimization adjustment on uTPS. This function enables the adjustment of the value of DVH indexes via prediction result used for optimization without model modification. For instance, the parameter -t% indicates that the predicted index was reduced to t% of the original value. Based on the statistical analysis of dataset A and B, we set the parameters of prediction tolerance of Femoral Head L and Femoral Head R to align with the newly added criteria, which are presented in Table2.

Transfer learning is a widely used approach to implementing domain adaptation. In our study, we employed the pre-trained model on Dataset A as the prototype model, and fine-tuned part of the model parameters through continued training. Considering the similarity of two datasets, we opted to freeze the encoder of the model (as shown in Fig.3) to enable the model to learn the features of the dose distribution on the newly added criteria while maintaining the anatomical features.

Mixture Density Network is a regression model that produces a probability of the entire distribution. The training process is to maximize the degree of fit between the parameter distribution and the data. In this study, the most commonly used Gaussian mixture model was selected as the mixture network for the voxel-wise regression. Each voxel is described as a Gaussian mixture model, with the parameters predicted by the deep learning-based model.

In this study, we set C = 2, and. We selected the channels representing the mean values as the dose predicted distribution. Thus, the MDN method predicts two distributions simultaneously. Moreover, the model training of MDN does not differentiate between Dataset A and B.

We evaluated the accuracy of dose prediction and the effect of the generated treatment plans.

To assess the dose prediction, we calculated Mean Error (ME) and Mean Absolute Error (MAE) of each voxel within ROIs. The ME is used to assess the deviation of the overall mean of the dose prediction results, while the MAE is used to evaluate the voxel-wise accuracy for each patient. Then the DVH indexes of the predicted dose distribution corresponding to the goal sheet were evaluated.

where D2%, D98% and D50% are the doses received by 2%, 98% and 50% of the target volume, respectively.

In this study, the training set, the evaluation set and the test set of Dataset A and B were split into 160/20/20 and 10/5/6, respectively. To facilitate the comparison of our models, we use several abbreviations below. Specifically, we donate the prototype of model (trained on Dataset A, 160 cases) as MA, and the prototype of model (trained on Dataset B, 10 cases) as MB. MAand MBserve as the baselines of the evaluation, representing the original prediction model and directly trained model by a limited dataset, respectively. ThePrediction Tolerancefunction is abbreviated to PT, and the model with transfer learning is marked as Mt. The dose distribution predicted by the mean values of MDN are marked as MDNAand MDNB, respectively.

In terms of dose prediction, the shape and spacing of model inputs are uniformly set toand. The hyper-parameters of models are listed in Table3. In addition, the early-stopping method is applied to avoid over-fitting.

In terms of automatic optimization, 2 beams of 360 degrees were applied for VMAT plans with gantry angles ranging from 0 to 360°. Dose calculation was performed using Collapsed Cone (CC). The Stochastic Platform Optimization (SPO) is applied as the optimization method, and the optimization loops is 30.

As visualized in Fig.4, it is noteworthy that MB, Mtand MDNBreduced the dosage of Femoral Heads, which is in line with the newly added criteria. The ranking of the predicted results by the degree of performing calibration is MB> Mt> MDNB(regardless of predictive rationality). The two distributions generated from MDN at one time distinguished the difference criteria corresponding plans. In addition, compared to clinical plans, the results of MDNAis more accurate than those of MA.

Tables4and5show the results evaluated on Datasets on ME and MAE, which are calculated on the output matrix. Table4is used to observe the average prediction trend, while Table5is used to evaluate the voxel-by-voxel difference in dose. TheDose Tolerancemethod does not produce dose distribution and therefore is not included in the comparison. Table6shows that MAhas a small error with Dataset A but performs poorly on Dataset B, indicating the importance of adapting to the criteria. Besides, for all methods, the standard deviations of Femoral Heads are high, suggesting varying degrees of dose limitation in the Dataset B. It is believed that the Femoral Head L/R in the average value of ME is slightly below 0 because the training set contains random data limited the dosage of Femoral Heads, causing data inconsistencies. MA tends to be trained as an average model under the circumstance, while MDN method is able to distinguish the different data distribution. According to Tables4and5, MDNAhas a low difference with Dataset A in both ME and MAE. Concerning Dataset B, MB, Mtand MDNBsignificantly reduced the dosage of Femoral Heads, among which MBreduced the most, and MDNBreduced the least, but other OARs have a higher robustness. From the perspective of MAE, the prediction of Mtand MDNBoutperformed MB.

The comparison of DVH prediction results are listed in Table6. The results show that MDNAhas a lower ME and MAE than MAon Dataset A, indicating that the MDN method is more accurate in predicting DVH indexes. For Dataset B, MB, Mtand MDNBsignificantly reduced the dosage of Femoral Heads, with MBhaving the most significant reduction. Additionally, the prediction of point indexes such as Dmax and D0.01 cc are not accurate enough for all methods, while other indexes besides those mentioned above are acceptable, with MAE mostly less than 5%.

The Fig.5illustrated the trend chart of difference methods. The x-axis represents each single patient case, while y-axis shows the DVH index value. Row 1 and 2 represent the predicted Dmean of Femoral Head L and R, respectively. The banded area is the enclosed area of MDNAand MDNBresults. It can be observed that the trend of clinical plans and the upper bound of the banded area can fit well, particularly in Dataset A. The predicted results of MA+PT are close to the lower bound. However, there are some extreme cases, such as test case 6 in Dataset B, whose dose of Femoral Heads are lower than the baseline MAby around 50%.

These extreme cases lead to an over-contribution of the MSE-based loss function so that make the prediction results of MBand Mton the low side. It is obviously that the MDN method has ability to handle the outliner.

As shown in Appendix Fig.1, the employment of calibrated methods resulted in a notable reduction in the dosage of Femoral Heads. Specifically, the DVH curves of Femoral Heads of MA+PT, Mtand MDNBexhibited lower values compared to the clinical plan on Dataset A, and were either comparable to or improved upon the clinical plan on Dataset B. In addition, the automatic optimization led to a reduction in the dosage of Spinal Cord.

Tables7and8show the average error of automated planning results compared to the origin plans. Table7are generated on the CT and structure contours on Dataset A, and Table8on Dataset B. On Table7, ROIs of MDNAmethod are slightly higher than MA, which was consistent with the results of dose prediction. Additionally, all the calibration approaches significantly reduced the dosage of Femoral Heads (p< 0.05), but with different planning styles. MA+PT got the highest Spinal Cord D0.01 cc, possibly due to its directly method separating the correlation or ROIs. The MBreduce Femoral Heads extremely, leading to the highest Dmax of PCTV and R4. Notably, Mtretained more features of MAcompared to MB. MDNBobtained the fewest Femoral Heads adjustment but also lowest Dmax of PCTV and Spinal Cord.

Besides, as shown in Table9, we calculated the average CI and HI, which showed that the calibration methods performed similarly with little difference. Among the methods, as for non-calibrated prediction, MDNAgot the lower MU, better CI and HI than MA. As for calibrated approaches, MDNBgot the highest CI and lowest HI, indicating superior performance overall. To provide a more reasonable comparison between the different approaches, we ranked the results of CI and HI, where the lower ranks means better performance. The results showed that MDNBoutperformed other approaches in terms of CI ranking, while Mtgot the best HI ranking.

The feasibility of calibration methods are shown in Table10. The results of approaches were compared with the difference of the actual optimization outcomes and the predicted dose distributions. It shows that the dose prediction predicted by MDNBexhibited greater consistency with the actual optimization results, and had the highest distributed rationality among all the approaches, which highlights that the potential of MDN as a reliable calibration method for dose prediction.

It is ideal for dose prediction is that the predicted dose is exactly the same as the clinical dose. However, the prediction result is affected by many aspects. In this study, we believe that there are three reasons for the inaccurate prediction results: the heterogeneous of dataset, the input information, and the loss function.

The radiation treatment planning Dataset is a special type of data that may correspond to multiple pareto plans with the same ROI and constraints as inputs. Due to the difficulty in quantifying planning style, it is challenging to ensure consistency among plans. As a result, models fed with this dataset are prone to predicting average results due to the presence of inherent aleatoric uncertainty (e.g., the results of MA is affected by data inconsistency). While such uncertainty cannot be completely eliminated, it can be reduced by improving style consistency during planning generation processes and implementing more stringent data screening procedures.

CT values and machine parameters need to be considered in the dose calculation process (i.e. the generation of the clinical dose distribution). Considering that CT values are easily affected by equipment, we only input the masks of ROIs into the model to avoid overfitting. In addition, little work has been done to combine dose prediction with machine modeling, making it difficult for models to directly produce results similar to dose calculation. In some existing work, beam raytracing are entered into the model, but in most cases, dose prediction does not take beam information into account, especially for VMAT. Therefore, in the case of fewer input features of the model, the predicted isolines are always smooth.

Based on the results of dose prediction, it is evident that Dmax/D0.01 cc is poorly predicted, particularly for Spinal Cord. This is due to the fact that Dmax/D0.01 cc has more randomness and is not a statistical representation of the region, but rather a maximum value of the distribution. This maximum value can be influenced by various factors such as the planning adjustment time and the distance between PTV and OAR. However, the MSE-based loss function and the negative log-likelihood loss function is calculated voxel-by-voxel, which is non-aware of specific location of Dmax/D0.01 cc. One potential solution is to apply the single point loss function to encourage the model to recognize the limitations of Dmax/D0.01 cc. However, since Dmax/D0.01 cc is inherently stochastic, using a single value of loss may not produce desirable results. Another approach is to incorporate a fixed condition of Dmax/D0.01 cc in the optimization process instead of relying on the predicted value, but the fixed value may not be patient-specific.

We utilized the trained MDN model to re-predict the Dataset. Besides, we calculated and normalized the position of DVH index of ground truth on the interval of A and B distribution of MDN, and visualized on Fig.6. It is noteworthy that MDN has an ability of clustering to some extent. The result revealed that there were some cases where Femoral Heads actually reduced existing in Dataset A, leading to lower prediction results of MArelative to MDNA. Additionally, Dataset B presented a large standard deviation, making it more susceptible to outliers and resulting in MSE-based deep learning models, such as MBand Mt, being less effective.

As Fig.7shows, the weightand varianceof voxels reflects the distribution of the dataset. MDNAand MDNBcorrespond to non-calibration and criteria-calibration Femoral Heads styles, respectively. The weight map of the Femoral Heads in MDNAis higher than MDNB, indicating that there are more higher-dose-style data, which is consistent with the fact that Dataset A is much larger than Dataset B. In addition, the variance map of MDNBhas a highlighted area on Femoral Heads, which performs same as the conclusion of dataset analysis.

However, due to its unsupervised attribute, there is no guarantee as to which distribution would be fit on the specific GMM. For instance, the predicted results of Bone Marrow on MDNB are higher than MDNA in this study, which is not expected.

In this study, we demonstrated an automatic knowledge-based planning workflow, and compared three criteria-calibration approaches to solve the data imbalance problem in dose prediction. The results demonstrated that these approaches can partially calibrate the pre-existing model with newly added criteria to some extent, and have their different emphases. ThePrediction Tolerancefunction on uTPS directly adjusts the prediction results without any modifications of the model, and is the most time-efficient method, suitable for less demanding situations. For cervical cancer patients who have a strong desire of ovarian protection and else who suffer from myelosuppressive after chemotherapy [33,34], thisPrediction Tolerancefunction on uTPS is highly efficacious. In contrast, the transfer learning-based approach requires minimal training time and data, to generate acceptable automatic results. The MDN approach although requiring the longest training time, has the ability to achieve robust prediction results and facilitate dataset analysis. These criteria-calibration approaches can generate feasible radiation treatment plans, trade-off in various ways, and be implemented at the specific requirements in different scenarios.

Notably, the current study was constrained by the clinical availability of Dataset B, which limited our exploration of the minimum feasible dataset size for effective criterion calibration. To address this limitation, future work will incorporate two key directions: (1) Subset Analysis: Evaluating the performance of the three methods using progressively smaller subsets of Dataset B to empirically determine the lower bound of data size required for robust calibration; (2) Theoretical Demonstration: Analyzing the relationship between dataset size and method performance to establish theoretical frameworks for guiding data acquisition in clinical auto-planning scenarios. These efforts will enhance the generalizability of our findings and provide practical guidelines for implementing criteria-calibration approaches under varying clinical data constraints.

Below is the link to the electronic supplementary material.

This work is supported by National Key R&D Program of China, Ministry of Science and Technology of the People’s Republic of China (No. 2022YFC2404606).