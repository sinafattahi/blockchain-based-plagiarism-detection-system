To explore the efficacy of a deep learning (DL) model in predicting perineural invasion (PNI) in prostate cancer (PCa) by conducting multiparametric MRI (mpMRI)-based tumor heterogeneity analysis.

This retrospective study included 397 patients with PCa from two medical centers. The patients were divided into training, internal validation (in-vad), and independent external validation (ex-vad) cohorts (n= 173, 74, and 150, respectively). mpMRI-based habitat analysis, comprising T2-weighted imaging, diffusion-weighted imaging, and apparent diffusion coefficient sequences, was performed followed by DL, deep feature selection, and filtration to compute a radscore. Subsequently, six models were constructed: one clinical model, four habitat models (habitats 1, 2, 3, and whole-tumor), and one combined model. Receiver operating characteristic curve analysis was performed to evaluate the models’ ability to predict PNI.

The four habitat models exhibited robust performance in predicting PNI, with area under the curve (AUC) values of 0.862–0.935, 0.802–0.957, and 0.859–0.939 in the training, in-vad, and ex-vad cohorts, respectively. The clinical model had AUC values of 0.832, 0.818, and 0.789 in the training, in-vad, and ex-vad cohorts, respectively. The combined model outperformed the clinical and habitat models, with AUC, sensitivity, and specificity values of 0.999, 1, and 0.955 for the training cohort. Decision curve analysis and clinical impact curve analysis indicated favorable clinical applicability and utility of the combined model.

DL models constructed through mpMRI-based habitat analysis accurately predict the PNI status of PCa.

The online version contains supplementary material available at 10.1186/s12885-025-14759-9.

Prostate cancer (PCa) is a key health concern for men worldwide. Its incidence is the highest among American men (approximately 29%). Despite notable progress in cancer prevention and improvements in mortality rates, the incidence of PCa continues to increase annually by 2% to 3% [1,2].

Perineural invasion (PNI) refers to the infiltration of tumor cells into peripheral nerves, where the cells encase nerve fibers and locally infiltrate into nerve sheaths, resulting in localized spread [3,4]. Thus, neural infiltration leads to local recurrence and adverse prognosis in patients with PCa. To ensure sound decision-making regarding the necessity of prostate biopsy for PCa diagnosis, prevailing guidelines [5] recommend multiparametric MRI (mpMRI) in addition to diagnostic tools such as prostate imaging reporting and data system (PI-RADS), transrectal ultrasound examination, and prostate-specific antigen detection; however, none of these tools can be used to reliably determine the preoperative PNI status of PCa [6,7]. Conventional MRI lacks high specificity for detecting extracapsular extension [8]. Currently, PNI in patients with PCa is assessed using invasive methods such as biopsy or surgical resection. Thus, to aid clinicians in making appropriate diagnosis and treatment decisions, a reliable, stable, and objective method must be developed for determining preoperative PNI in patients with PCa.

Machine learning has been gaining traction in clinical oncology, particularly in diagnosis, treatment outcome prediction, and treatment planning. The availability of rich imaging data has facilitated the application of machine learning, with numerous studies demonstrating its relevance in cancer detection, progression monitoring, and treatment decision-making [9,10]. Convolutional neural networks (CNNs) are widely used in deep learning (DL) and excel in processing data with grid-like structures, such as images [11,12].

Tumor heterogeneity is prevalent across cancers [13–15]. Owing to the complexity and multifactorial nature of tumor heterogeneity, a tumor’s regional features such as necrosis, peritumoral edema, and enhancement contribute to tumor heterogeneity. Analyzing these features can provide comprehensive insights into tumor characteristics. However, most imaging studies have analyzed the entire tumor region [16,17], potentially overlooking internal heterogeneity. Furthermore, intratumoral heterogeneity is often macroscopically indiscernible and challenging to manually label preoperatively [18]; these problems lead to limited findings on regional differences and suboptimal approaches to tumor subregion analysis [19]. As a typical representative of clustering algorithms, K-means employs cluster algorithms or “habitat imaging” to generate coherent subregions on the basis of similarity [20]. By assigning data points to different cluster centers, K-means clustering ensures high intracluster similarity and significant intercluster differences, enabling voxel clustering based on similarity and revealing underlying data structures [18].

Previous studies have attempted to predict PNI in PCa using deep learning or radiomics models based on mp-MRI. A study [21] reported that a deep learning model achieved an AUC of 0.914 and 0.848 for PNI prediction in the training and validation cohorts, respectively. Another study [22] developed a radiomics model using random forest, yielding an AUC of 0.82 for PNI prediction. However, these methods rely either solely on deep learning or on conventional radiomics features. To our knowledge, no prior study has combined habitat-based analysis with ResNet-101 for PCa PNI prediction.

The novelty of our approach lies in the integration of unsupervised K-means clustering to explicitly model tumor heterogeneity, followed by deep feature extraction from each habitat region using ResNet-101. This structured framework aims to leverage both spatial heterogeneity and high-level semantic features, which may provide advantages over traditional single-method approaches. Whether this strategy better captures tumor biology and enhances predictive performance compared to purely deep learning or radiomics approaches is a question worth investigating.

In this study, preoperative mpMRI data from patients with PCa were used to develop several DL habitat subregion models by using the K-means classification method and ResNet-101 neural networks; additionally, a WT model was developed. Furthermore, clinical data and multiple DL habitat models were integrated to construct a combined model for preoperatively predicting PNI in patients with PCa.

This study adhered to the principles of the 1964 Declaration of Helsinki and received approval from the Institutional Review Boards (IRBs) of Tongde Hospital of Zhejiang Province (2022–234 K) and Taizhou First People’s Hospital (2024-006-01). Given its retrospective nature, the requirement for informed consent was waived. This study included 397 patients who received a confirmed diagnosis of PCa at two medical centers between January 2018 and December 2022. Of these, 247 patients were enrolled from Center 1 and randomly divided into the training cohort (n= 173) and the internal validation (in-vad) cohort (n= 74) using a 7:3 ratio based on a computer-generated randomization. The remaining 150 patients from Center 2 were used as an independent external validation (ex-vad) cohort.

The inclusion criteria were as follows: undergoing PCa surgery or biopsy and having PNI pathological results, undergoing MRI scans before surgery of biopsy, and not receiving any antitumor treatment (radiation therapy, chemotherapy, or others) before MRI. The exclusion criteria were as follows: a concurrent diagnosis of PCa with other primary malignant tumors and the unavailability of clinical or imaging data (Fig.1).

Simense 3.0T Verio (center 1) and 1.5T Avanto (center 2) MRI scanners were employed. Three MRI sequences (T2WI, DWI, and ADC sequences) were selected, covering the entire required range (prostate and seminal vesicle). After completing the DWI sequence scan, the machine automatically generated ADC maps. Scan parameters for each sequence are detailed in Table1.

A radiologist with 18 years of experience in abdominal imaging–based diagnosis interpreted the mpMRI results for all patients. Subsequently, a radiologist with 24 years of experience in abdominal imaging–based diagnosis confirmed the interpretations. Any discrepancy between the two radiologists was resolved through consultation. The following data were recorded and analyzed: age, total prostate-specific Antigen (TPSA), morphology (round, quasi-circular, irregular), location (peripheral zone [PZ], transitional zone [TZ] or central zone [CZ], PZ + TZ or PZ + CZ), position (left, right, bilateral), number of lesions (unitary, multiple), seminal vesicle invasion (negative or positive), capsule Invasion (negative or positive), rectal invasion (negative or positive), ADC Value, mrT (T stage on MRI) stage (T1-T4), PI-RADS (≤ 3, 4, or 5). Scores of 1, 2, 3, 4, and 5 on the PI-RADS (version 2.1) [23] corresponded to very low (clinically significant cancer is highly unlikely to be present), low (clinically significant cancer is unlikely to be present)), intermediate (clinically significant cancer may or may not be present), high (clinically significant cancer may be present), and very high (clinically significant cancer is highly likely to be present) risks of clinically significant PCa, respectively. The apparent diffusion coefficient (ADC) measurement method involves retrieving a scanned ADC map from a picture archiving and communication system, dragging it into the viewing card, selecting the circular region of interest (ROI) tool, drawing a circle in the ROI covering the tumor to the highest extent possible, and obtaining the corresponding value—ADC (mm2/s)—automatically.

The DL process comprises six steps. The experimental workflow is illustrated in Fig.2.

Step 1. Preparation of data: PCa MRI images, including T2-weighted imaging (T2WI), diffusion-weighted imaging (DWI), and ADC sequences in DICOM format, were subjected to rigid registration by using the simple insight segmentation and registration toolkit library. The DWI images were used as standard templates, onto which the other images were aligned. Subsequently, the ROI was delineated using ITK-SNAP (version 3.4), thereby generating mask images for T2WI, DWI, and ADC sequences. Prior to any analysis, all images were resampled to isotropic voxels of 1 mm × 1 mm × 1 mm, and intensity normalization was performed using z-score standardization. The images were delineated by the radiologist with 18 years of experience, and the tumor boundaries were confirmed by the radiologist with 24 years of experience. In case of any disagreement, consensus was achieved through discussion.

Step 2. Determination of the optimal number of clusters: The pixel values of the mask regions in all images from the three sequences were extracted. During the pixel-level feature extraction phase, features from all three MR sequences were concatenated into single pixel-wise feature vectors and standardized using the StandardScaler method to ensure scale-invariant comparisons across modalities and scanners. The unsupervised K-means clustering method was applied to these pixel values. The Calinski–Harabasz (CH) value was used as the criterion for determining the optimal number of clusters. The CH index was calculated for different numbers of clusters. A higher CH index indicates better differentiation between clusters and higher compactness within clusters. After several trials with different k values were conducted, an optimal k value of 3 was determined.

Step 3. Generation of mask region habitats: First, the pixel values of the mask regions in all images from the three different sequences were extracted for the same patient. Subsequently, all pixel values were combined to construct a total matrix. Prior to clustering, all pixel-level feature vectors were again standardized with the StandardScaler to further reduce domain-related heterogeneity. Then, the optimal number of clusters (n= 3) was selected, and pixel-based K-means clustering was applied to the total matrix to divide the mask region into three subregions.

Step 4. Extraction of subregion DL features: Data processing was implemented in Python 3.7 (https://www.python.org/) and PyCharm Community Edition (https://pytorch.org/). The pretrained ResNet-101 architecture served as the foundational model for feature extraction. T2WI, DWI, and ADC images from different sequences and their corresponding subregion mask images were incorporated into the model. The last fully connected layer of the ResNet-101 model was removed, and DL features were extracted for different subregions through average pooling. Then, these features, along with relevant labels, were integrated into a file for subsequent analysis or further data mining.

Step 5. Calculation of DL feature scores: The minimum redundancy maximum relevance method was used for the initial screening of DL features. Subsequently, the least absolute shrinkage and selection operator method with 10-fold cross-validation was used to further reduce dimensionality and select the most relevant features for model construction.

Step 6. Validation of the model: Models were trained and then evaluated on internal and external validation sets.

After surgery, tissue samples were subjected to hematoxylin–eosin staining and immunohistochemical analysis; the experiments were performed by a pathologist with 15 years of relevant experience, and the results were reviewed by another pathologist with 20 years of diagnostic experience. Any disagreement between the two pathologists was resolved by results from immunohistochemical staining with S100 or neurofilament protein. PNI was defined as tumor cells surrounding, partially encircling or infiltrating, or invading nerves [24].

Statistical analysis was conducted using R software. For continuous data, normality was tested first. For normally distributed data, the t-test was used for comparisons between two groups, while the Mann-Whitney U test was used for non-normally distributed data. The chi-square test was used for comparisons between two groups of count data. Variables withp<.05 in univariate analysis were included in the logistic regression model to establish the clinical model. The diagnostic models established were evaluated for performance using ROC curves. Model comparisons were performed using the DeLong test, with statistical significance set atp<.05 (two-sided).

The patients’ mean age was 74.9 ± 7.7 (range: 44–94) years. Among the 397 patients, 66 tested positive for PNI (19.4%, 77/397) and 320 cases of negative PNI (80.6%, 320/397). In the training set, the positive and negative PNI cohorts differed significantly (p<.05) in terms of age, mrT stage, and PI_RADS score but not in terms of TPSA, morphology, location, position, number of lesions, seminal vesicle invasion, capsule invasion, rectal invasion, and ADC Value. Univariate and multivariate analyses indicated Age (odds ratio = 0.92,P=.04), mrT Stage (odds ratio = 1.83;p=.034) and PI_RADS score (odds ratio = 3.12;p=.002) as independent PNI predictors eligible for constructing the clinical model (Fig.3). Clinical and MRI data for the training, in-vad, and ex-vad groups are presented in Table2.

The CH index reached its maximum value when K was 3; thus, K = 3 indicated the optimal number of clusters for this study (Fig.4a). Consequently, the mask region was partitioned into three distinct habitat subregions: habitats 1, 2, and 3 (Fig.4b). The entire tumor’s habitat area was labeled as habitat WT. A heatmap was generated for each habitat subregion (Fig.4c).

Using the pre-trained ResNet-101 model, a total of 6144 deep features were extracted from the habitat regions; 2048 features extracted from each of the T2WI, DWI, and ADC sequences in habitats 1, 2, and 3, respectively. Feature selection began with the minimum redundancy maximum relevance method, followed by dimensionality reduction by using the least absolute shrinkage and selection operator method with 10-fold cross-validation. Consequently, 29 deep features were selected for Habitat 1 (12 from T2WI, 9 from DWI, and 8 from ADC), 29 for Habitat 2 (10 from T2WI, 10 from DWI, and 9 from ADC), 20 for Habitat 3 (9 from T2WI, 5 from DWI, and 6 from ADC), and 22 for Habitat WT (7 from T2WI, 5 from DWI, and 10 from ADC). These features were linearly combined to calculate Radscore_Habitat1, Radscore_Habitat2, Radscore_Habitat3, and Radscore_WT (Table2, Figures S1a-d).

Six models were constructed using clinical features and multiple DL radscores: one clinical model, four habitat models (habitats 1, 2, 3, and WT), and one combined model (clinical + habitat models).

In PNI prediction, the AUC values of the clinical model in the training, internal validation, and external validation cohorts were 0.832 (95% CI, 0.755–0.908), 0.818 (0.703–0.934), and 0.789 (0.704–0.873), respectively. The AUC values of habitats 1–3 in all three cohorts (range: 0.802–0.957) surpassed those of the clinical model. The AUC values of the habitat WT model in the training, internal validation, and external validation cohorts were 0.919 (0.868–0.970), 0.902 (0.828–0.976), and 0.828 (0.735–0.921), respectively. The combined model achieved AUC values of 0.999 (0.996–1.0), 1.000 (1.0–1.0), and 0.955 (0.922–0.988) in the training, internal validation, and external validation cohorts, respectively (Fig.5a–c). The AUC, accuracy, sensitivity, specificity, positive predictive values, and negative predictive values of each model are shown in Table3.

The Delong test revealed that the combined model outperformed the clinical model (p<.05) in the training cohort. Habitats 2 and 3 outperformed the clinical model (p<.05). However, habitats 1 and WT did not differ significantly from the clinical model in terms of performance (p>.05). No significant difference was observed among the four habitat models (p>.05). Further details of model comparisons are presented in Table4. The decision curve analysis revealed that the combined model yielded a higher clinical net benefit across a broad range of threshold probabilities than did the four habitat models (Fig.6a). The clinical impact curve indicated the high clinical efficiency of the combined model across risk thresholds ranging from 0.2 to 1.0 (Fig.6b).

To our knowledge, there have been no studies employing mpMRI habitat analysis and DL models to predict and validate the PNI status of PCa. In this study, we used pixel values from MRI sequence images for K-means clustering. Leveraging ResNet-101, we constructed multiple DL cluster models—habitat models—to predict the PNI status of PCa. The findings confirmed the robust ability of the habitat models to predict the PNI status. Notably, the combined model, where clinical factors were integrated with multiple habitat models, exhibited exceptional predictive efficacy; the stability and reliability of this model were validated in the internal and external validation cohorts.

PNI in PCa indicates the infiltration of tumor cells into nerve bundles and surrounding tissues, leading to a poor prognosis [25]. Currently, PNI status is primarily determined through biopsy or histopathological analysis. Preoperative imaging cannot precisely indicate PNI status. Our clinical model revealed that PNI was correlated with age, mrT stage, and PI-RADS score: the risk of PNI was higher in older patients, those with higher T-stage scores, and those with higher PI-RADS scores. As PCa cells spread along the nerves, the cells proliferate, infiltrating a large number of nerves outside the prostate capsule. When the tumor breaches the prostate capsule, it invades peripheral nerves. Lee et al. [26] analyzed the relationship between PNI and clinicopathological features in 361 patients with PCa and found a correlation between PNI and T stage. A combination of the mpMRI-based PI-RADS and prostate-specific antigen detection is highly sensitive in assessing PCa invasiveness and detecting small, early-onset, and low-risk PCa. A score of 5 on the PI-RADS indicates tumor invasion beyond the prostate and invasive behavior [27], providing valuable insights for clinical pathways and treatment planning.

The development of a tumor is accompanied by an increase in heterogeneity, which affects treatment response and causes adverse clinical outcomes [28]. Tumor heterogeneity cannot be adequately captured through overall tumor analysis; this limitation reduces the value of the analysis results [29]. Researchers have been investigating the feasibility of using information on tumor heterogeneity to guide clinical practice [19]. In the analysis of tumor heterogeneity, tumor subregions are correlated with different biological behaviors, representing distinct prognostic feature. However, the delineation and recognition of different subregions pose challenges in imaging studies. The widely adopted approach in clinical practice involves the subjective judgment of radiologists, who delineate various tumor subregions by visually analyzing MRI signal intensity. Nonetheless, this approach is dependent on expertise, which leads to interobserver variability. Consequently, it may fail to comprehensively capture internal heterogeneity [20]. In some studies [30,31], intra- and peritumoral radiomic models have been constructed to predict tumor prognosis by expanding tumor boundaries. Although these models represent tumor regions and the peritumoral environment, they cannot accurately reflect tumor heterogeneity. In our study, K-means clustering was performed to generate cluster labels for intratumoral regions and four habitat clusters by using T2WI, DWI, and ADC sequence data. These labels were used to visualize changes in cluster pattern distributions and quantify tumors. The K-means clustering algorithm [32] calculates the mean grayscale value of all pixels in each category in a sample to obtain cluster centroids. The voxel characteristics of different regions are highly useful in differentiating among various tumor features; thus, habitat clustering of different tumor subregions may exhibit heterogeneity [33].

In practice, deepening network structures does not always improve performance and may even reduce performance; this phenomenon is known as the “degradation problem.” ResNet-101 addresses this problem by introducing residual learning, thereby avoiding gradient disappearance and enabling network deepening without compromising performance [12,34]. In radiomics, DL is widely used because of its high accuracy. The reasonable combination of K-means clustering and ResNet-101 in our study improved the habitat models’ performance in predicting PNI in PCa. Notably, the Delong test revealed no significant difference between the habitat WT model and the other three subregion habitat models, indicating that the subregions segmented using the K-means clustering algorithm and the habitat WT model exhibit similar predictive abilities for tumor prognosis. Feng et al. [29] partitioned breast cancer lesions into three subregions by using a semiautomatic segmentation method and constructed machine learning models and nomograms by using clinical and radiomic features from these subregions and the entire tumor. The AUC values of the subregion models constructed from the habitat were 0.805 and 0.737 in the training and validation cohorts, respectively, while the AUC values of the nomogram were 0.830 and 0.879. Shi et al. [35] evaluated neoadjuvant chemotherapy response in patients with breast cancer by analyzing intratumoral subregions, and constructed a combined model, which achieved the highest AUC value, indicating the gain of additional information from tumor heterogeneity for predicting the efficacy of neoadjuvant chemotherapy. Similarly, our combined model exhibited improved predictive performance, confirming that different subregions complement each other and reflect tumor heterogeneity multidimensionally. Furthermore, the clinical impact curve indicated that when the risk threshold ranged from 0.2 to 1.0, the predicted high-risk population for PNI was consistent with the actual population with PNI, indicating the high clinical efficiency and applicability of the combined model.

Classifiers play a pivotal role in radiomics. In the present study, logistic regression (LR) was employed as the primary modeling method. As a widely adopted approach in radiomics research, LR is a linear model with a fully transparent decision-making process. In our modeling workflow, each feature is assigned a corresponding coefficient, the absolute value of which quantitatively reflects its contribution to the predictive outcome. This transparency enhances interpretability, enabling clinicians to better understand and trust the model, thereby facilitating the translation of model findings into clinical knowledge and decision-making. Moreover, we observed that the LR-based models exhibited favorable stability and reliability, achieving robust predictive performance across both internal and external datasets. Yao et al. [36] developed a deep learning model based on ResNet-101 using preoperative multiparametric MRI and postoperative HE-stained multimodal data to predict the microsatellite instability (MSI) status in rectal cancer. After extracting deep features, they employed LR for model construction, which yielded satisfactory predictive performance in both the training and internal/external validation cohorts. Similarly, our previous studies [37,38] also adopted LR after feature extraction and demonstrated promising results across training and validation datasets. Collectively, these studies highlight the advantages of logistic regression, including superior interpretability, direct probabilistic outputs, computational efficiency, robustness, and its compatibility with regularization techniques—particularly Lasso—for effective feature selection.

This study has several limitations. First, the relatively small sample size may affect the robustness of the habitat-based model, underscoring the need for validation in larger cohorts. External validation across diverse populations, MRI scanners, and institutions is crucial to verify its reliability and generalizability in clinical practice. Second, the ROIs in MRI images were manually delineated, which may introduce observer bias. Future research should explore automated segmentation techniques, such as U-Net architectures [39,40], to reduce human intervention. Finally, although CNN models are extensively used in research on medical imaging, future investigations should compare various DL models to comprehensively analyze their differences and advantages in imaging studies.

In conclusion, our habitat clustering DL models constructed using the K-means clustering algorithm effectively predicted the PNI status of PCa. These models offer insights into intratumoral microheterogeneity, thereby facilitating the optimization of preoperative personalized treatment strategies.

WA designed the study. SD and WA took charge of the writing of this paper. XH and HZ to data collection. DH and HW for data analysis. SD were responsible for the software and statistics. GM contributed to the literature search. WA took charge of review and editing of the manuscript. All authors have read and approved the manuscript.

This work was supported by Medical Science and Technology Project of Zhejiang Province (NO.2022KY122, 2023KY079, 2024KY052); Zhejiang Traditional Chinese Medicine Administration (NO.2024ZL040).